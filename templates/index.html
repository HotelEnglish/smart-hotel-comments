<!DOCTYPE html>
<html>
<head>
    <title>智慧酒店评论爬虫</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .progress {
            margin: 20px 0;
        }
        #results {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>智慧酒店评论爬虫</h1>
        
        <div class="card mt-4">
            <div class="card-body">
                <form id="scrapeForm">
                    <div class="mb-3">
                        <label class="form-label">关键词</label>
                        <input type="text" class="form-control" id="keyword" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">选择网站</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="ctrip" id="ctrip" checked>
                            <label class="form-check-label">携程</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="booking" id="booking">
                            <label class="form-check-label">Booking.com</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="agoda" id="agoda">
                            <label class="form-check-label">Agoda</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">每个网站爬取页数</label>
                        <input type="number" class="form-control" id="pages" value="50">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">开始爬取</button>
                </form>
            </div>
        </div>
        
        <div id="status" style="display: none;">
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            <p class="text-center" id="statusText"></p>
        </div>
        
        <div id="results"></div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let isRunning = false;
        
        $('#scrapeForm').on('submit', function(e) {
            e.preventDefault();
            
            if (isRunning) {
                alert('爬虫正在运行中');
                return;
            }
            
            const sites = [];
            $('input[type=checkbox]:checked').each(function() {
                sites.push($(this).val());
            });
            
            if (sites.length === 0) {
                alert('请至少选择一个网站');
                return;
            }
            
            const data = {
                keyword: $('#keyword').val(),
                sites: sites,
                pages_per_site: parseInt($('#pages').val())
            };
            
            $.ajax({
                url: '/start_scraping',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.error) {
                        alert(response.error);
                    } else {
                        isRunning = true;
                        $('#status').show();
                        updateStatus();
                    }
                }
            });
        });
        
        function updateStatus() {
            $.get('/status', function(data) {
                $('.progress-bar').css('width', data.progress + '%');
                
                let statusText = `正在爬取: ${data.current_site}<br>`;
                statusText += `已获取评论数: ${data.total_reviews}`;
                
                if (data.error) {
                    statusText += `<br>错误: ${data.error}`;
                }
                
                $('#statusText').html(statusText);
                
                if (data.is_running) {
                    setTimeout(updateStatus, 1000);
                } else {
                    isRunning = false;
                    getResults();
                }
            });
        }
        
        function getResults() {
            $.get('/results', function(data) {
                let html = '<h3>爬取结果</h3>';
                
                for (let site in data) {
                    html += `<h4>${site}</h4>`;
                    html += `<p>获取到 ${data[site].length} 条评论</p>`;
                    
                    if (data[site].length > 0) {
                        html += '<table class="table">';
                        html += '<thead><tr><th>酒店名称</th><th>评论内容</th><th>日期</th></tr></thead>';
                        html += '<tbody>';
                        
                        data[site].forEach(review => {
                            html += `<tr>
                                <td>${review.hotel_name}</td>
                                <td>${review.content}</td>
                                <td>${review.date}</td>
                            </tr>`;
                        });
                        
                        html += '</tbody></table>';
                    }
                }
                
                $('#results').html(html);
            });
        }
    </script>
</body>
</html> 